name: Build push image and generate chart 
on:
  push:
    branches:
      - main
jobs:
  bump-ver-push-tag:
    name: Bump version and push tag 
    runs-on: ubuntu-latest
    outputs:
        tag: ${{ steps.tag_version.outputs.new_tag }}
    steps:
      - name: Checkout   
        uses: actions/checkout@v3
      
      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag_prefix: "" 
  
  build-and-push-image:
    name: Build and push image 
    needs: bump-ver-push-tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkecout
        uses: actions/checkout@v3
      
      - name: Login to the Container registry
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v3
        with:
          context: ./nextcloud
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/nextcloud:${{ needs.bump-ver-push-tag.outputs.tag }}
  
  lint-helm:
    name: Helm Lint
    needs: bump-ver-push-tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Helm
        uses: Azure/setup-helm@v3
        with:
          version: v3.10.0

      - name: Helm lint
        run: |
          helm lint ./charts/nextcloud              
  
  chart-release:
    name: Chart release
    needs: [bump-ver-push-tag, lint-helm]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: Azure/setup-helm@v3
        with:
          version: v3.10.0

      - name: Update appVersion
        run: |
          sed -i "s/^version:.*$/version: ${{ needs.bump-ver-push-tag.outputs.tag }}/" ./charts/nextcloud/Chart.yaml
          sed -i "s/^appVersion:.*$/appVersion: ${{ needs.bump-ver-push-tag.outputs.tag }}/" ./charts/nextcloud/Chart.yaml

      - name: Generate Chart
        run: |
          helm package ./charts/nextcloud
          helm repo index --url https://tony-by.github.io/nextcloud-ci/releases --merge index.yaml .
          mv -f nextcloud-* ./releases
          git add .
          git commit -m "Chart release version ${{ needs.bump-ver-push-tag.outputs.tag }}"
          git push origin main
  
  slackNotification:
    name: Slack notofication
    needs: [bump-ver-push-tag, build-and-push-image, chart-release]
    runs-on: ubuntu-latest
    steps:
    - name: Slack Notify
      uses: rtCamp/action-slack-notify@v2.2.0
      env:
          SLACK_CHANNEL: notifications
          SLACK_COLOR: ${{ job.status }} # or a specific color like 'good' or '
          SLACK_ICON: https://github.com/rtCamp.png?size=48
          SLACK_MESSAGE: 'Nextcloud chart release v${{ needs.bump-ver-push-tag.outputs.tag }} Status: ${{ job.status }} :rocket:'
          SLACK_TITLE: Chart Release
          SLACK_USERNAME: rtCamp
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
